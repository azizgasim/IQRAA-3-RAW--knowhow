#!/usr/bin/env bash
# 01_upload_master_file.sh
# ุฑูุน ููู master_books ุฅูู ูุณุงุฑ GCS ุงูููุงุณู ููุณุงุฑ ุงููุชุจ ูู ููุตุฉ ุฅูุฑุฃ

set -euo pipefail

#############################################
# ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ (ูููู ุชุนุฏูููุง ุนูุฏ ุงูุญุงุฌุฉ)
#############################################

# ุงุณู ูุดุฑูุน ุฌูุฌู ููุงูุฏ
PROJECT_ID="iqraa-12"

# ุงุณู ุงูุจูุช ุงูุฎุงู ููููุตุฉ
GCS_BUCKET="iqraa-12-raw"

# ููุน ุงูููุงู (ููุง: ูุชุจ)
ENTITY_TYPE="books"

#############################################
# ุฏุงูุฉ: ุทุจุงุนุฉ ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู
#############################################

usage() {
  cat <<EOF_USAGE
ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู:

  $0 LOCAL_FILE DATE SOURCE_SYSTEM

ุญูุซ:
  LOCAL_FILE    : ูุณุงุฑ ุงูููู ุนูู ุงูุณูุฑูุฑ (ูุซุงู: /home/azizamlgasim/data/master_books.parquet)
  DATE          : ุชุงุฑูุฎ ุงูุฏูุนุฉ ุจุตูุบุฉ YYYY-MM-DD (ูุซุงู: 2025-11-29)
  SOURCE_SYSTEM : ุงุณู ุงููุธุงู ุฃู ุงููุตุฏุฑ (ูุซุงู: portal ุ legacy_catalog ุ publisher_api)

ุงููุซุงู:

  $0 /home/azizamlgasim/data/master_books.parquet 2025-11-29 portal

ุณูุชู ุงูุฑูุน ุฅูู:

  gs://${GCS_BUCKET}/${ENTITY_TYPE}/date=2025-11-29/source=portal/master_books.parquet

ููุงุญุธุงุช:
- ุชุฃูุฏ ุฃู ุฃุฏุงุฉ gsutil ุชุนูู ูุฃูู ุฏุงุฎู ูุดุฑูุน ${PROJECT_ID}.
- ุงูุณูุฑุจุช ูุง ูููู ุจุงูุชุญููู ุฅูู Parquetุ ููุท ูุฑูุน ุงูููู ููุง ูู.
EOF_USAGE
}

#############################################
# ุงูุชุญูู ูู ุงููุณุงุฆุท (arguments)
#############################################

if [[ $# -ne 3 ]]; then
  echo "โ ุนุฏุฏ ุงููุณุงุฆุท ุบูุฑ ุตุญูุญ."
  usage
  exit 1
fi

LOCAL_FILE="$1"
INGEST_DATE="$2"
SOURCE_SYSTEM="$3"

#############################################
# ุงูุชุญูู ูู ูุฌูุฏ ุงูููู ุงููุญูู
#############################################

if [[ ! -f "$LOCAL_FILE" ]]; then
  echo "โ ุงูููู ุงููุญูู ุบูุฑ ููุฌูุฏ: $LOCAL_FILE"
  exit 1
fi

#############################################
# ุจูุงุก ูุณุงุฑ ุงููุฌูุฉ ุนูู GCS
#############################################

DEST_PATH="gs://${GCS_BUCKET}/${ENTITY_TYPE}/date=${INGEST_DATE}/source=${SOURCE_SYSTEM}/master_books.parquet"

echo "============================================="
echo "๐ฆ ุฑูุน ููู Master Books ุฅูู GCS"
echo "---------------------------------------------"
echo "ูุดุฑูุน ุฌูุฌู ููุงูุฏ : ${PROJECT_ID}"
echo "ุงูุจูุช            : ${GCS_BUCKET}"
echo "ุงูููุงู           : ${ENTITY_TYPE}"
echo "ุงูููู ุงููุญูู     : ${LOCAL_FILE}"
echo "ุชุงุฑูุฎ ุงูุฏูุนุฉ     : ${INGEST_DATE}"
echo "ูุธุงู ุงููุตุฏุฑ      : ${SOURCE_SYSTEM}"
echo "ุงููุฌูุฉ ุงูููุงุฆูุฉ  : ${DEST_PATH}"
echo "============================================="

#############################################
# ุชูููุฐ ุฃูุฑ ุงูุฑูุน ุจุงุณุชุฎุฏุงู gsutil
#############################################

echo "๐ ุฌุงุฑู ุฑูุน ุงูููู ุฅูู GCS ..."
gsutil cp "${LOCAL_FILE}" "${DEST_PATH}"

echo "โ ุชู ุงูุฑูุน ุจูุฌุงุญ."
echo "โ ููููู ุงูุขู ุงุณุชุฎุฏุงู ูุฐุง ุงููุณุงุฑ ูู ุฎุทูุฉ ุงูุชุญููู ุฅูู BigQuery:"
echo "   ${DEST_PATH}"
