# ═══════════════════════════════════════════════════════════════════════════════
#                    IQRA-12 Dynamic Composition Engine
#                         محرك التكوين الديناميكي
# ═══════════════════════════════════════════════════════════════════════════════

## المبدأ المركزي

> **"الوكيل ليس كياناً ثابتاً، بل تركيبة ديناميكية تتشكل من السؤال"**

هذا المحرك يحول سؤال الباحث إلى Pipeline من العمليات الذرية.

---

## المعمارية

```
┌─────────────────────────────────────────────────────────────────┐
│                      سؤال الباحث                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              1. Question Parser (محلل الأسئلة)                  │
│  • تصنيف نوع السؤال (9 أنواع)                                   │
│  • استخراج الكيانات والمفاهيم                                   │
│  • تحديد النطاق الزمني والجغرافي                                │
│  • تقييم التعقيد                                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│            2. Pipeline Builder (باني الـ Pipeline)              │
│  • مطابقة الوصفات الجاهزة                                       │
│  • اختيار العمليات المناسبة                                     │
│  • حل التبعيات وترتيب التنفيذ                                   │
│  • تحسين الأداء والتوازي                                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│           3. Pipeline Executor (منفذ الـ Pipeline)              │
│  • تنفيذ العمليات بالتوازي                                      │
│  • إدارة الحالة والاستئناف                                      │
│  • معالجة الأخطاء                                               │
│  • تتبع التقدم والـ Provenance                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         النتيجة                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## هيكل الملفات

```
iqra12_composition_engine/
│
├── README.md                      # هذا الملف
├── 00_ENGINE_OVERVIEW.yaml        # نظرة عامة على المحرك
│
├── 01_question_parser.yaml        # محلل الأسئلة
│   ├── Question Classifier        # مصنف الأسئلة (9 أنواع)
│   ├── Entity Extractor           # مستخرج الكيانات
│   ├── Concept Extractor          # مستخرج المفاهيم
│   ├── Scope Detector             # كاشف النطاق
│   ├── Output Detector            # كاشف المخرج المتوقع
│   ├── Complexity Assessor        # مقيّم التعقيد
│   └── Ambiguity Detector         # كاشف الغموض
│
├── 02_pipeline_builder.yaml       # باني الـ Pipeline
│   ├── Recipe Matcher             # مطابق الوصفات
│   ├── Operation Selector         # منتقي العمليات
│   ├── Dependency Resolver        # حالّ التبعيات
│   ├── Pipeline Optimizer         # محسّن الـ Pipeline
│   └── Cost Estimator             # مقدّر التكلفة
│
├── 03_pipeline_executor.yaml      # منفذ الـ Pipeline
│   ├── Operation Runner           # مشغّل العمليات
│   ├── State Manager              # مدير الحالة
│   ├── Parallel Executor          # المنفذ المتوازي
│   ├── Error Handler              # معالج الأخطاء
│   ├── Progress Tracker           # متتبع التقدم
│   └── Provenance Recorder        # مسجّل الأصل
│
├── 04_operation_registry.yaml     # سجل العمليات (44 عملية)
│
└── 05_recipe_library.yaml         # مكتبة الوصفات (7 وصفات)
```

---

## أنواع الأسئلة المدعومة

| النوع | الاسم | أنماط التعرف | مثال |
|-------|-------|--------------|------|
| TRACING | تتبع | كيف انتقل، ما أصل، تطور | "كيف انتقل مفهوم الجوهر من أرسطو..." |
| COMPARATIVE | مقارنة | ما الفرق، قارن، التشابه | "قارن بين موقف الأشاعرة والمعتزلة..." |
| INFLUENCE | تأثير | هل أثر، ما تأثير، العلاقة بين | "هل أثر المنطق اليوناني على..." |
| POSITION | موقف | ما موقف، رأي، كيف نظر | "ما موقف ابن رشد من..." |
| DEFINITION | تعريف | ما معنى، ما هو، تعريف | "ما معنى الماهية في..." |
| NETWORK | شبكة | من تلاميذ، شيوخ، سلسلة | "من هم تلاميذ الغزالي..." |
| TIMELINE | جدول زمني | متى، ترتيب، مراحل | "ما مراحل تطور علم الكلام..." |
| GAP_DISCOVERY | فجوات | ما المهمل، غير المدروس | "ما المواضيع المهملة في..." |
| SYNTHESIS | تركيب | اكتب، لخص، أعد تقريراً | "اكتب ورقة عن..." |

---

## الوصفات الجاهزة

| # | الوصفة | النوع | العمليات | التكلفة |
|---|--------|-------|----------|---------|
| 1 | تتبع انتقال مفهوم عبر الثقافات | TRACING | 14 | $0.70 |
| 2 | مقارنة مواقف المدارس الكلامية | COMPARATIVE | 10 | $0.45 |
| 3 | تحليل موقف عالم من مسألة | POSITION | 7 | $0.30 |
| 4 | رسم شبكة التلاميذ والشيوخ | NETWORK | 7 | $0.25 |
| 5 | تعريف مصطلح مع تطوره | DEFINITION | 5 | $0.15 |
| 6 | اكتشاف الفجوات البحثية | GAP_DISCOVERY | 3 | $0.10 |
| 7 | كتابة ورقة بحثية كاملة | SYNTHESIS | 22 | $2.00 |

---

## تدفق التنفيذ - مثال

**السؤال:**
> "كيف انتقل مفهوم 'الجوهر' من أرسطو إلى علم الكلام الإسلامي؟"

**1. التحليل (Question Parser):**
```yaml
question_type: TRACING
confidence: 0.95
entities:
  - {text: "أرسطو", type: PERSON, role: source}
  - {text: "علم الكلام", type: DOMAIN, role: destination}
concepts:
  - {term: "الجوهر", original: "οὐσία", role: traced}
complexity: HIGH
```

**2. بناء الـ Pipeline:**
```
Phase 1: [E1, E2] ─────────► البحث
Phase 2: [E3, E6] ─────────► استخراج الكيانات
Phase 3: [T1] ─────────────► التتبع المعجمي
Phase 4: [L2, L4] ─────────► الربط
Phase 5: [T2, T3] ─────────► التتبع المفاهيمي
Phase 6: [C1, C2] ─────────► البناء
Phase 7: [S1, S4] ─────────► التركيب
Phase 8: [V1, V2] ─────────► التحقق ✓
```

**3. التنفيذ:**
- 14 عملية
- 8 مراحل
- ~10 دقائق
- ~$0.70

---

## سجل العمليات - ملخص

```
Total Operations: 44
├── Extract:    E1-E6  (6)
├── Link:       L1-L5  (5)
├── Trace:      T1-T5  (5)
├── Analyze:    A1-A6  (6)
├── Construct:  C1-C6  (6)
├── Synthesize: S1-S5  (5)
├── Write:      W1-W5  (5)
└── Verify:     V1-V6  (6)
```

---

## التبعيات الأساسية

```
[E1, E2] ──► [E3, E6] ──► [L1, L2, L4, L5]
                │              │
                ▼              ▼
           [E4, E5]      [T1, T2, T3, T4, T5]
                │              │
                ▼              ▼
           [A1-A6]       [C1] ──► [C2] ──► [C3]
                              │
                              ▼
                         [S1, S2, S5]
                              │
                              ▼
                         [W1] ──► [W2] ──► [W5]
                              │
                              ▼
                    [V1, V2, V4] ══► PUBLISH ✓
```

---

## بوابات الجودة

### إلزامية (لا نشر بدونها):
- **V1:** تدقيق الاستشهادات
- **V2:** تدقيق الاتساق
- **V4:** تدقيق الأصل (Provenance)

### اختيارية:
- **V3:** تدقيق التغطية
- **V5:** تدقيق الحقوق
- **V6:** اختبار النسق

---

## معالجة الأخطاء

| نوع الخطأ | الوصف | المعالجة |
|-----------|-------|----------|
| TRANSIENT | مؤقت (timeout, rate limit) | إعادة المحاولة |
| RECOVERABLE | يمكن تجاوزه | استخدام بديل |
| DATA_ERROR | خطأ في البيانات | إعلام المستخدم |
| QUALITY_FAILURE | فشل بوابة جودة | إرجاع للتصحيح |
| FATAL | لا يمكن المتابعة | إيقاف التنفيذ |

---

## واجهة برمجية (API)

```
POST   /api/v1/parse      # تحليل السؤال
POST   /api/v1/build      # بناء الـ Pipeline
POST   /api/v1/execute    # تنفيذ الـ Pipeline
GET    /api/v1/status/:id # حالة التنفيذ
POST   /api/v1/resume/:id # استئناف التنفيذ
GET    /api/v1/result/:id # الحصول على النتيجة
```

---

## للمبرمجين

### نقاط البدء:
1. ابدأ بـ `01_question_parser.yaml` - فهم تصنيف الأسئلة
2. ثم `04_operation_registry.yaml` - فهم العمليات المتاحة
3. ثم `05_recipe_library.yaml` - الوصفات الجاهزة
4. ثم `02_pipeline_builder.yaml` - منطق البناء
5. أخيراً `03_pipeline_executor.yaml` - التنفيذ

### التحويل إلى كود:
- كل ملف YAML قابل للتحويل إلى Python/TypeScript
- الـ Schemas محددة بوضوح
- التبعيات موثقة

---

## الإحصائيات

```
الملفات:           6 ملفات YAML
المكونات:          18 مكون فرعي
أنواع الأسئلة:     9 أنواع
العمليات:          44 عملية
الوصفات:           7 وصفات
التبعيات الموثقة:  ~60 تبعية
```

---

## العلاقة مع طبقة العمليات

هذا المحرك يعتمد على:
- **iqra12_operations_contracts/** - العقود التفصيلية للـ 44 عملية

ويُنتج:
- خطط تنفيذ (Execution Plans)
- نتائج موثقة مع Provenance كامل

---

**إقرأ-12** | محرك التكوين الديناميكي | 2024
